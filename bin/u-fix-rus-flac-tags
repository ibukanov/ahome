#!/bin/sh

tags="$(mktemp)"
cleanup() {
  rm "$tags"
}
trap cleanup EXIT

for i in "$@"; do

  metaflac --no-utf8-convert --export-tags-to=- "$i" \
    | iconv -t windows-1252 |iconv -f windows-1251 > "$tags"
  if test $? -ne 0; then
    exit 1
  fi

  artist="$(cat "$tags" | grep ARTIST | cut -d= -f2)"
  album="$(cat "$tags" | grep ALBUM | cut -d= -f2)"
  track="$(cat "$tags" | grep TRACKNUMBER | cut -d= -f2)"
  title="$(cat "$tags" | grep TITLE | cut -d= -f2)"

  echo "$i"
  echo "  artist=$artist"
  echo "  album=$album"
  echo "  track=$track"
  echo "  title=$title"

  if test -z "$artist" -o -z "$album" -o -z "$track" -o -z "$title"; then
    echo "Failed to extract either artist, album, track or title" 1>&2
    cat "$tags" >&2
    exit 1
  fi

  if echo "$artist$album$track$title" | grep -q -e "/"; then
    echo "tags contain / which is not good" 1>&2
    cat "$tags" >&2
    exit 1
  fi
  case $track in
    [1-9] ) track="0$track" ;;
    [1-9][0-9] ) ;; 
    * ) echo "track '$track' is not a 1 or 2 digits number" 1>&2; exit 1 ;;
  esac

  dir="$(dirname "$i")/../../$artist/$album"
  mkdir -p "$dir"
  file="$dir/$track - $title.flac"
  cp -a "$i" "$file" 
  metaflac --no-utf8-convert --remove-all-tags --preserve-modtime \
    --import-tags-from="$tags" "$file"
done